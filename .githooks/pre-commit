#!/usr/bin/env bash
set -euo pipefail

if ! command -v clang-format >/dev/null 2>&1; then
  echo "pre-commit: clang-format not found in PATH" >&2
  exit 1
fi

files=()
while IFS= read -r -d '' file; do
  case "$file" in
    *.c|*.cc|*.cpp|*.cxx|*.h|*.hh|*.hpp|*.hxx)
      files+=("$file")
      ;;
  esac
done < <(git diff --cached --name-only -z --diff-filter=ACMR)

if [ ${#files[@]} -eq 0 ]; then
  exit 0
fi

clang-format -i "${files[@]}"
git add "${files[@]}"

echo "pre-commit: formatted ${#files[@]} file(s) with clang-format"
